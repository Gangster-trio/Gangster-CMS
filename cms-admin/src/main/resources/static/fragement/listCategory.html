<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-3.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<button style="float: right;margin: 5px" class="layui-btn layui-btn-normal" id="column">添加栏目</button>
<div class="layui-elem-quote" style="margin-bottom: 0;">
    <p>栏目管理</p>
</div>
<script src="/util/util.js"></script>
<table id="column_table" class="layui-table" style="margin: 0px" lay-filter="columnlist"></table>

<script>
    //判断该用户是否拥有对栏目的基本操作
    function judgePrivalige(id) {

    }

    var categoryId;
    layui.use('table', function () {
        var first = true;
        var table = layui.table;
        if (siteId) {
            table.render({
                elem: '#column_table'
                , url: '/category/list?siteId=' + siteId
                , page: true //开启分页
                , cols: [[ //表头
                    {field: 'categoryId', title: 'ID', width: '80', sort: true, fixed: 'left'}
                    , {field: 'categoryTitle', title: '栏目名', width: '190', align: 'center'}
                    , {field: 'categoryCreateTime', title: "创建时间", width: '110', align: 'center', sort: true}
                    , {field: 'categoryUpdate', title: '更新时间', width: '110', align: 'center', sort: true}
                    , {field: 'categoryLevel', title: '级别', width: '80', align: 'center', sort: true}
                    , {field: 'categoryStatus', title: '状态', width: '80', align: 'center', sort: true}
                    , {field: 'categoryDesc', title: '描述', width: '190', align: 'center'}
                    , {filed: 'tool', title: '操作', align: 'center', toolbar: "#toolBar"}
                ]]
                , limit: 10
                , limits: [10, 15, 20, 40, 80, 100]
                , done: function (res, curr, count) {
                    if (first) {
                        layer.msg("加载完成 共" + count + "条数据");
                        first = false;
                    }
                }
            });
            table.on('tool(columnlist)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var id = data.categoryId;   //得到当前点击的栏目id
                categoryId = id;
                if (layEvent === 'detail') { //查看
                    showAtRight("/fragement/listArticle.html");
                } else if (layEvent === 'del') { //删除
                    var delPrivalige = true;
                    $.ajax({
                        url: "category/privalige/" + id,
                        dataType: "json",
                        type: "get",
                        success: function (data) {
                            if (data.code === 2) {
                                delPrivalige = false;
                                layer.msg("sorry ,you have not privalige");
                            }
                        }
                    });
                    if (delPrivalige) {
                        layer.confirm('真的删除行么', function (index) {
                                deleteCategory(id);
                                obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                                layer.close(index);
                                showAtRight("/fragement/listCategory.html");
                            }
                        )
                    }
                } else if (layEvent === 'edit') { //  跳转到栏目编辑界面
                    var editPrivalige = true;
                    $.ajax({
                        url: "category/privalige/" + id,
                        dataType: "json",
                        type: "get",
                        success: function (data) {
                            if (data.code === 2) {
                                editPrivalige = false;
                                layer.msg("sorry ,you have not privalige");
                            }
                        }
                    });
                    if (editPrivalige) {
                        layer.open({
                            id: 1,
                            type: 2,
                            skin: 'layui-layer-rim',
                            area: ['700px', '600px'],
                            closeBtn: 1,
                            anim: 0,
                            maxmin: true,
                            content: '/fragement/editCategory.html?id=' + categoryId,
                            success: function (layero, index) {
                                console.log(layero, index);
                            },
                            end: function () {
                                showAtRight("/fragement/listCategory.html");
                            }
                        });
                    }
                } else if (layEvent === 'add') {   //跳转到添加文章界面
                    var addPrivalige = true;
                    $.ajax({
                        url: "category/privalige/" + id,
                        dataType: "json",
                        type: "get",
                        success: function (data) {
                            if (data.code === 2) {
                                privalige = false;
                                layer.msg("sorry ,you have not privalige");
                            }
                        }
                    });
                    if (addPrivalige) {
                        layer.open({
                            id: 1,
                            type: 2,
                            skin: 'layui-layer-rim',
                            area: ['700px', '600px'],
                            closeBtn: 1,
                            anim: 0,
                            maxmin: true,
                            content: '/fragement/addArticle.html?categoryId=' + categoryId,
                            success: function (layero, index) {
                                console.log(layero, index);
                            },
                            end: function () {
                                showAtRight("/fragement/listCategory.html");
                            }
                        });
                    }
                }
            });
        } else {
            layer.open({
                title: '栏目管理'
                , content: '请先选择所要操作的站点'
            });
        }
    });
</script>

<script type="text/html" id="toolBar">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="add">
            <i class="layui-icon">&#xe654;</i>
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="detail">
            <i class="layui-icon">&#xe705;</i>
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="edit">
            <i class="layui-icon">&#xe642;</i>
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="del">
            <i class="layui-icon">&#xe640;</i>
        </button>
    </div>
</script>
<script>
    var index = $("#column").on('click', function () {
        layer.open({
            id: 2,
            type: 2,
            skin: 'layui-layer-rim',
            area: ['700px', '600px'],
            closeBtn: 1,
            anim: 0,
            maxmin: true,
            content: '/fragement/addCategory.html?siteid=' + siteId,
            success: function (layero, index) {
                console.log(layero, index);
            }
        });
    });

    function deleteCategory(id) {
        $.ajax({
                url: "/category/delete/" + id,
                dataType: "json",
                type: "get",
                timeout: "3000",
                error: function () {
                    layer.msg("server no response : " + url);
                },
                success: function (data) {
                    if (data.code === 0) {
                        layer.msg("delete success.")
                    } else if (data.code === 1) {
                        layer.msg("delete false");
                    } else if (data === 2) {
                        layer.msg("sorry,you have not privalige");
                    }
                }
            }
        );

    }


</script>

</html>