<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="utf-8"/>
    <title></title>
    <link href="/layui/css/layui.css" rel="stylesheet"/>
    <link href="/tag/css/tag.css"/>
    <script src="/layui/layui.js"></script>
    <script type="text/javascript" src="/util/jquery.min.js"></script>
    <script src="/util/jquery.form.js"></script>
    <script src="/util/util.js"></script>
    <link rel="stylesheet" type="text/css" href="/tag/jquery.tagsinput.css"/>
    <script type="text/javascript" src="/util/jquery.tagsinput.js"></script>
    <script type='text/javascript'
            src='/util/jquery-ui.min.js'></script>
    <link rel="stylesheet" type="text/css"
          href="/tag/jquery-ui.css"/>
</head>
<body style="background-color:#eee;">
<div class="layui-form">
    <div class="layui-form-item">
        <label class="layui-form-label">文章标题</label>
        <div class="layui-input-inline">
            <input type="text" id="articleTitle" name="articleTitle" required lay-verify="required" placeholder="文章名称"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">自定义顺序</label>
        <div class="layui-input-inline">
            <input type="text" id="order" name="order" required lay-verify="required" placeholder="自定义顺序"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <form class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">文章属性</label>
            <div class="layui-input-block">
                <!--<input type="radio" name="sex" value="女" title="女" checked>-->
                <!--单选框name 为控件名，value是提交到服务器的值-->
                <input type="radio" name="choose" value="carousel" title="轮播图">
                <input type="radio" name="choose" value="index" title="主页文章">
                <input type="radio" name="choose" value="normal" title="普通文章" checked="checked">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">选择皮肤</label>
            <div class="layui-input-block">
                <!--<input type="radio" name="sex" value="女" title="女" checked>-->
                <!--单选框name 为控件名，value是提交到服务器的值-->
                <input type="radio" name="skin" value="default" title="默认" checked="checked">
            </div>
        </div>
    </form>
    <div id="show" class="layui-form-item">
        <label class="layui-form-label">所属栏目</label>
        <div class="layui-input-inline">
            <input type="text" id="belongCategory" name="belongCategory" required="required" lay-verify="required"
                   placeholder="顶级栏目管理"
                   autocomplete="off"
                   class="layui-input" readonly="readonly"/>
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <form id="img" action="/article/img" method="post" enctype="multipart/form-data">
            <img width="100" height="100" style="margin-left: 40px" id="image"/><br/>
            <!-- 在选择图片的时候添加事件，触发Ajax异步上传 -->
            <input name="file" style="margin-left: 40px" type="file" onchange="uploadImg()"/>
        </form>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">文章作者</label>
        <div class="layui-input-inline">
            <input type="text" id="author" name="author" required lay-verify="required" placeholder="文章作者"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">描述</label>
        <div class="layui-input-block">
            <textarea id="description" name="description" required class="layui-textarea" placeholder="添加描述"></textarea>
        </div>
    </div>
    <form>
        <input type="text" id="addNewTag" value=""/><input type="submit" onclick="addNewTag();" value="添加"/>
        <p><label>标签</label>
            <input id="tags_2" type="text" class="tags" value=""/></p>
    </form>
    <p style="margin-left: 50px"> 文章内容</p>
    <div style="width:90%;margin-left:5%;margin-top:100px;background-color:#fff;">
        <textarea name="txt" id="txt" required style="display:none;"></textarea>
    </div>
    <input id="parentId" name="parentId" type="text" hidden="hidden"/>
    <input type="button" value="提交文章" lay-filter="addArticle" id="btn1" class="layui-btn"
           style="margin-left:10%;margin-top:20px;"/>
</div>
</body>
</html>
<script type="text/javascript">
    $(function () {
            layui.use('layedit', 'form', function () {
                var layedit = layui.layedit;
                var form = layui.form;
                form.render();
                layedit.set({
                    uploadImage: {
                        url: '/article/img' //接口url
                        , type: 'post' //默认post
                        , size: 0
                    }
                });

                var editIndex = layedit.build('txt', {
                    height: 400
                });


                //如果栏目未指定，就显示指定栏目的框，如果指定，就隐藏
                var categoryId = getUrlVar("categoryId");
                if (!categoryId) $("#show").show();  //categoryId未定义就是false
                else {
                    $("#show").hide();
                    $("#parentId").val(categoryId);
                }

                //提交文章事件
                form.on('submit(addArticle)', function () {
                    alert(getUrlVar("siteId"));
                    if (!categoryId) {
                        var articleCategoryId = document.getElementById("parentId").value;
                    } else {
                        articleCategoryId = categoryId;
                    }
                    // if (categoryId.length === 0) categoryId = initCategoryId;
                    var articleContent = layedit.getContent(editIndex);     //得到layui编辑器里边的文章
                    var tags = $("#tags_2").val();
                    $.ajax({
                        url: "/article/save/",
                        type: 'post',
                        dataType: 'json',
                        contentType: "application/json",
                        data: JSON.stringify({
                            "articleTitle": $("#articleTitle").val(),
                            "articleType": chooseValue("choose"),
                            "articleAuthor": $("#author").val(),
                            "articleOrder": $("#order").val(),
                            "articleSiteId": getUrlVar("siteId"),
                            "articleCategoryId": articleCategoryId,
                            "articleDesc": $("#desc").val(),
                            "articleSkin": chooseValue("skin"),
                            "articleContent": articleContent,
                            "tags": tags
                        }),
                        success: function (data) {
                            console.log(data);
                            if (data.code === 0) {
                                //关闭弹框
                                layer.msg("添加成功", {icon: 6});
                            } else {
                                layer.msg("添加失败", {icon: 5});
                            }
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        }
                    });
                });
            });
        }
    )
</script>
<script type="text/javascript">
    $("#belongCategory").on('click', function () {
        layer.open({
            id: 1,
            type: 2,
            skin: 'layui-layer-rim',
            closeBtn: 1,
            anim: 5,
            content: '/fragement/selectCategory.html',
            success: function (layero, index) {
                console.log(layero, index);
            }
        });
    });

    function uploadImg() {
        var options = {
            url: "/article/img",
            type: 'post',
            dataType: "json",
            success: function (data) {
                $("#image").attr("src", data.src);
            }
        };
        $("#img").ajaxSubmit(options);
    }
</script>
<script type="text/javascript">

    function onAddTag(tag) {
        alert("Added a tag: " + tag);
    }

    function onRemoveTag(tag) {
        alert("Removed a tag: " + tag);
    }

    function onChangeTag(input, tag) {
        alert("Changed a tag: " + tag);
    }

    $(function () {

        $('#tags_1').tagsInput({width: 'auto'});
        $('#tags_2').tagsInput({
            width: 'auto',
            onChange: function (elem, elem_tags) {
                var languages = ['php', 'ruby', 'javascript'];
                $('.tag', elem_tags).each(function () {
                    if ($(this).text().search(new RegExp('\\b(' + languages.join('|') + ')\\b')) >= 0)
                        $(this).css('background-color', 'yellow');
                });
            }
        });
        $('#tags_3').tagsInput({
            width: 'auto',

            //autocomplete_url:'test/fake_plaintext_endpoint.html' //jquery.autocomplete (not jquery ui)
            autocomplete_url: 'test/fake_json_endpoint.html' // jquery ui autocomplete requires a json endpoint
        });


// Uncomment this line to see the callback functions in action
//			$('input.tags').tagsInput({onAddTag:onAddTag,onRemoveTag:onRemoveTag,onChange: onChangeTag});

// Uncomment this line to see an input with no interface for adding new tags.
//			$('input.tags').tagsInput({interactive:false});
    });

</script>