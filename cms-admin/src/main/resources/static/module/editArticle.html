<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend>更新文章</legend>
</fieldset>
<div class="site-text site-block">
    <form id="updateArticleForm" class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">文章标题</label>
            <div class="layui-input-inline">
                <input type="text" name="articleTitle" id="articleTitle" required="" lay-verify="required"
                       placeholder="请输入文章标题" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">自定义顺序</label>
            <div class="layui-input-inline">
                <input type="text" id="articleOrder" name="articleOrder" required="" lay-verify="required|number"
                       placeholder="自定义顺序" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">辅助文字</div>
        </div>
        <!--<div class="layui-input-block">
            <input type="radio" name="articleType" value="carousel" title="轮播图">
            <input type="radio" name="articleType" value="index" title="主页文章">
            <input type="radio" name="articleType" value="normal" title="普通文章" checked="checked">
        </div>-->
        <div class="layui-form-item">
            <label class="layui-form-label">文章类型</label>
            <div class="layui-input-inline">
                <select id="articleType" name="city" lay-verify="required">
                    <option value="carousel">轮播图</option>
                    <option value="index">主页文章</option>
                    <option value="normal">普通文章</option>
                </select>
            </div>
        </div>
        <!--<div class="layui-input-inline">-->
        <!--<input type="text" name="articleType" value="" title="自定义类型" placeholder="自定义类型" class="layui-input">-->
        <!--<div class="layui-form-mid layui-word-aux">自定义模板时使用</div>-->
        <!--</div>-->
        <!--TODO: skin choose-->
        <div class="layui-form-item">
            <label class="layui-form-label">选择皮肤</label>
            <div class="layui-input-block">
                <!--<input type="radio" name="sex" value="女" title="女" checked>-->
                <!--单选框name 为控件名，value是提交到服务器的值-->
                <input type="radio" id="articleSkin" name="articleSkin" value="default" title="默认" checked="checked">
            </div>
        </div>
        <div id="show" class="layui-form-item">
            <label class="layui-form-label">所属栏目</label>
            <div class="layui-input-inline">
                <input id="category_id" class="layui-hide" name="articleCategoryId" required
                       lay-verify="required|number">
                <input type="text" id="belongCategory" required="required" lay-verify="required"
                       placeholder="选择栏目"
                       autocomplete="off"
                       class="layui-input" readonly="readonly"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">文章作者</label>
            <div class="layui-input-inline">
                <input type="text" id="articleAuthor" name="articleAuthor" required lay-verify="required"
                       placeholder="文章作者"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">Tag</label>
            <div class="layui-input-block">
                <input type="text" id="tags" name="tags" value="" placeholder="Tag"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <button type="button" class="layui-btn" id="test1">
                <i class="layui-icon">&#xe67c;</i>上传图片
            </button>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">描述</label>
            <div class="layui-input-block">
                <textarea id="articleDesc" name="articleDesc" required class="layui-textarea"
                          placeholder="添加描述"></textarea>
            </div>
        </div>

        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">文章内容</label>
            <div class="layui-input-block">
                <textarea name="articleContent" id="articleContent" class="layui-hide" lay-verify="content"></textarea>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button lay-submit class="layui-btn" lay-filter="updateArticle">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
    var updateArticle;
    $(function () {
            var layedit = layui.layedit;
            var form = layui.form;
            form.render();
            layedit.set({
                uploadImage: {
                    url: '/article/img' //接口url
                    , type: 'post' //默认post
                    , size: 0
                }
            });

            updateArticle = layedit.build('articleContent', {
                height: 400
            });
            form.on('submit(updateArticle)', function () {
                layui.layer.alert("enter form on func");
                updateArticleSubmit();
                layui.layer.alert("end");
                return false;
            });
            $.ajax({
                type: "get",
                url: "/article/details/" + articleId,  //得到需要更新文章的id
                success: function (data) {
                    console.log(data);
                    initCategoryId = data.articleCategoryId;
                    $("#articleTitle").val(data.articleTitle);
                    $("#articleType").val(data.articleType);
                    $("#articleOrder").val(data.articleOrder);
                    $("#articleAuthor").val(data.articleAuthor);
                    $("#belongCategory").val(data.categoryName);
                    $("#tags").val(data.tags);
                    $("#articleDesc").val(data.articleDesc);
                    layedit.setContent(updateArticle, data.articleContent);    //配置layui 文本编辑器回显
                }
            });
        }
    );
    //将form表单转化成Javascript object

    $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };


    function updateArticleSubmit() {
        layui.layedit.sync(updateArticle);
        formData = $("#updateArticleForm").serializeObject();
        layui.layer.alert("fomr data:" + JSON.stringify(formData));
        $.ajax({
            type: 'post',
            url: '/article/update/' + articleId,
            data: JSON.stringify(formData),
            async: false,
            contentType: "application/json",
            dataType: 'json',
            error: function (resp) {
                layui.layer.alert("failed. " + resp)
            },
            success: function (resp) {
                layui.layer.alert("添加成功 :" + resp);
                showAtRight("/module/listArticle.html");
            }
        });
    }

    $("#belongCategory").on('click', function () {
        // layer.alert("click belongCategory");
        $.get('/module/selectCategory.html', {}, function (str) {
            layer.open({
                type: 1,
                skin: 'layui-layer-rim',
                closeBtn: 1,
                anim: 5,
                area: ['300px', '350px'],
                content: str,
                success: function (layero, index) {
                    console.log(layero, index);
                }
            });
        });
    });
</script>